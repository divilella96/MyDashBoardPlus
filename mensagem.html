<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerar Report Bloqueio WhatsApp</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Gerar Report Bloqueio</h1>

    <form onsubmit="return false;">
      <label for="numero">Número WhatsApp</label>
      <input type="tel" id="numero" placeholder="+351 912 345 678 (P/ validar insira o seu!)" inputmode="tel">
    
      <label for="encomenda">Encomenda:</label>
      <input
        type="tel"
        id="encomenda"
        name="encomenda"
        placeholder="Ex: 00035625 / 530729"
        required
        inputmode="numeric"
      />
      <small id="erro-encomenda" style="color:red; display:none;">
      ⚠️ O número após a barra deve ter exatamente 6 dígitos.
      </small>

      <label for="bloqueio">Tipo de Bloqueio</label>
      <select id="bloqueio" onchange="mostrarOutro()">
        <option value="">-- Selecione o tipo de bloqueio --</option>
        <option>Erro "encomenda em processamento"</option>
        <option>O valor do pedido é superior ao valor permitido</option>
        <option>Erro de duplicidade</option>
        <option>Erro descohecido</option>
        <option>Outro (especificar abaixo)</option>
      </select>

      <div id="bloqueioOutro" style="display: none;">
        <label for="bloqueioOutro" class="visually-hidden">Especifique o tipo de bloqueio</label>
        <input type="text" id="bloqueioOutro" placeholder="Digite o tipo de bloqueio">
      </div>

      <label for="substituicao">Houve substituição?</label>
      <select id="substituicao" onchange="mostrarDescricaoSubstituicao()">
        <option value="">-- Selecione --</option>
        <option>Sim, teve substituição</option>
        <option>Não teve substituição</option>
        <option>Não teve substituição mas quero adicionar nota/descrição</option>
      </select>

      <div id="detalhesSubstituicao" style="display: none;">
        <label for="detalhesSubstituicao" class="visually-hidden">Detalhes da substituição ou nota adicional</label>
        <textarea id="detalhesSubstituicao" placeholder="Descreva os artigos substituídos ou a nota adicional..."></textarea>
      </div>

      <label for="ticket">Ticket</label>
      <input type="number" id="ticket" placeholder="1832377" inputmode="numeric">

      <button type="button" class="btn-whatsapp" onclick="gerarMensagem()">Gerar Mensagem</button>
      <button type="button" class="btn-primary" onclick="enviarWhatsApp()">Abrir no WhatsApp</button>
    </form>

    <h3>Prévia da Mensagem:</h3>
    <pre id="preview" aria-live="polite"></pre>

    <div class="visually-hidden" aria-live="polite" id="status-announcer"></div>
  </div>

  <script>
    let mensagemGerada = "";

    function mostrarOutro() {
      const select = document.getElementById("bloqueio");
      const outroCampo = document.getElementById("bloqueioOutro");
      if (select.value === "Outro (especificar abaixo)") {
        outroCampo.style.display = "block";
        outroCampo.focus();
      } else {
        outroCampo.style.display = "none";
        outroCampo.value = "";
      }
    }

    function mostrarDescricaoSubstituicao() {
      const select = document.getElementById("substituicao");
      const campoDescricao = document.getElementById("detalhesSubstituicao");
      if (
        select.value === "Sim, teve substituição" ||
        select.value === "Não teve substituição mas quero adicionar nota/descrição"
      ) {
        campoDescricao.style.display = "block";
        campoDescricao.focus();
      } else {
        campoDescricao.style.display = "none";
        campoDescricao.value = "";
      }
    }

    function gerarMensagem() {
      const encomenda = document.getElementById("encomenda").value;
      let bloqueio = document.getElementById("bloqueio").value;
      const bloqueioOutro = document.getElementById("bloqueioOutro").value;
      const substituicao = document.getElementById("substituicao").value;
      const detalhes = document.getElementById("detalhesSubstituicao").value;
      const ticket = document.getElementById("ticket").value;

      if (bloqueio === "Outro (especificar abaixo)" && bloqueioOutro.trim() !== "") {
        bloqueio = bloqueioOutro;
      }

      let textoSubstituicao = substituicao;
      if (detalhes.trim() !== "") {
        textoSubstituicao += `\n\n${detalhes}`;
      }

      const agora = new Date();
      const horas = String(agora.getHours()).padStart(2, '0');
      const minutos = String(agora.getMinutes()).padStart(2, '0');
      const horaFormatada = `${horas}:${minutos}`;

      mensagemGerada =
`Report Bloqueio

Encomenda: ${encomenda}
Tipo do Bloqueio: ${bloqueio}
Substituição: ${textoSubstituicao}

Já contactado o 2370 - ${horaFormatada}

Ticket: ${ticket}`;

      document.getElementById("preview").innerText = mensagemGerada;
      const announcer = document.getElementById('status-announcer');

      navigator.clipboard.writeText(mensagemGerada).then(() => {
        const botao = document.querySelector("button[onclick='gerarMensagem()']");
        const textoOriginal = botao.innerText;
        botao.innerText = "Copiado!";
        setTimeout(() => {
          botao.innerText = textoOriginal;
        }, 2000);
        announcer.textContent = 'Mensagem copiada para a área de transferência.';
        setTimeout(() => { announcer.textContent = '' }, 3000);

      }).catch(err => {
        console.error("Erro ao copiar a mensagem: ", err);
        announcer.textContent = 'Ocorreu um erro ao copiar a mensagem.';
        setTimeout(() => { announcer.textContent = '' }, 3000);
        alert("Ocorreu um erro ao copiar a mensagem.");
      });
    }

    function enviarWhatsApp() {
      const numero = document.getElementById("numero").value;
      if (!numero || !mensagemGerada) {
        alert("Preencha o número e gere a mensagem antes de enviar!");
        return;
      }
      const url = `https://wa.me/${numero}?text=${encodeURIComponent(mensagemGerada)}`;
      window.open(url, "_blank");
    }

    document.getElementById("numero").addEventListener("input", function(e) {
      let valor = e.target.value.replace(/\D/g, "");
      if(valor.startsWith("351")) {
        valor = "+" + valor.replace(/^351/, "351 ");
      } else if(valor.startsWith("55")) {
        valor = "+" + valor.replace(/^55/, "55 ");
      }
      valor = valor.replace(/(\+\d{2,3})(\d{3})(\d{3})(\d{3})$/, "$1 $2 $3 $4");
      e.target.value = valor;
    });

    document.getElementById("encomenda").addEventListener("input", function(e) {
      let valor = e.target.value.replace(/\D/g, "");
      if (valor.length > 8) {
        valor = valor.slice(0, 8) + " / " + valor.slice(8);
      }
      e.target.value = valor;
    });

    document.getElementById("ticket").addEventListener("input", function(e) {
      e.target.value = e.target.value.replace(/\D/g, ""); 
    });

    const campoEncomenda = document.getElementById("encomenda");
    const erro = document.getElementById("erro-encomenda");

    campoEncomenda.addEventListener("input", function(e) {
        let valor = e.target.value.replace(/[^0-9/]/g, ""); // só números e "/"

        if (valor.includes("/")) {
        let [antes, depois] = valor.split("/");
        antes = antes.trim();
        depois = depois.trim();
        depois = depois.slice(0, 6);
        valor = antes + " / " + depois;

        if (depois.length === 6) {
            erro.style.display = "none";
            campoEncomenda.setCustomValidity("");
        } else {
            erro.style.display = "block";
            campoEncomenda.setCustomValidity("O número após a barra deve ter exatamente 6 dígitos.");
        }
        }
        e.target.value = valor;
    });
  </script>
</body>
</html>
