<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comunicação Com Bot</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Comunicação Com Bot</h1>

    <div class="menu-buttons">
      <button class="btn-primary" onclick="showFlow('reagendamento')">Reagendamento</button>
      <button class="btn-primary" onclick="showFlow('alerta')">Alerta: Preciso de Motorista</button>
      <button class="btn-primary" onclick="showFlow('outro')">Outro</button>
    </div>

    <!-- FLUXO 1: REAGENDAMENTO -->
    <div id="reagendamento" class="flow-section">
      <h3>Reagendamento</h3>
      <form onsubmit="return false;">
        <!-- Phone hidden as requested -->
        <input type="hidden" id="bot-phone" value="+15558841462">

        <label>Encomendas</label>
        <div id="order-list">
          <div class="order-input-group">
            <input type="text" class="order-input" placeholder="Número da encomenda">
            <!-- First one typically doesn't have remove button unless we want to allow 0 orders, but usually at least 1 is needed.
                 Let's add remove button even for the first one for consistency, but maybe handle logic to not remove if it's the only one?
                 Or just let it be empty. -->
          </div>
        </div>
        <button class="btn-add" onclick="addOrderField()">+ Adicionar Encomenda</button>

        <label>Janela de Horário</label>
        <div class="time-inputs">
            <div>
                <label for="time-start" style="margin-top:0; font-size: 0.8rem;">Início</label>
                <select id="time-start" onchange="updateEndTime()">
                    <option value="">Selecione...</option>
                </select>
            </div>
            <div>
                <label for="time-end" style="margin-top:0; font-size: 0.8rem;">Fim</label>
                <select id="time-end">
                    <option value="">Selecione...</option>
                </select>
            </div>
        </div>

        <label>Tipo de Contato</label>
        <div class="radio-group">
          <label><input type="radio" name="contact-type" value="SMS" checked> SMS</label>
          <label><input type="radio" name="contact-type" value="Ligação"> Ligação</label>
        </div>

        <label>Canal de Envio</label>
        <div class="radio-group">
          <label><input type="radio" name="channel-reag" value="WhatsApp" checked> WhatsApp</label>
          <label><input type="radio" name="channel-reag" value="E-mail"> E-mail</label>
        </div>
      </form>
    </div>

    <!-- FLUXO 2: ALERTA -->
    <div id="alerta" class="flow-section">
      <h3>Alerta: Preciso de Motorista</h3>
      <form onsubmit="return false;">
        <label for="alert-time">Hora</label>
        <input type="time" id="alert-time">

        <label>Canal de Envio</label>
        <div class="radio-group">
          <label><input type="radio" name="channel-alert" value="WhatsApp" checked> WhatsApp</label>
          <label><input type="radio" name="channel-alert" value="E-mail"> E-mail</label>
        </div>
      </form>
    </div>

    <!-- FLUXO 3: OUTRO -->
    <div id="outro" class="flow-section">
      <h3>Outro</h3>
      <form onsubmit="return false;">
        <label for="other-order">Número da encomenda</label>
        <input type="text" id="other-order" placeholder="Número da encomenda">

        <label for="other-desc">Descrição</label>
        <textarea id="other-desc" placeholder="Descrição do problema..."></textarea>

        <label>Canal de Envio</label>
        <div class="radio-group">
            <label><input type="radio" name="channel-other" value="WhatsApp" checked> WhatsApp</label>
            <label><input type="radio" name="channel-other" value="E-mail"> E-mail</label>
        </div>
      </form>
    </div>

    <div class="output-section" id="output-section" style="display:none;">
      <div style="display:flex; gap:10px;">
        <button class="btn-primary" onclick="generateAndSend()">Enviar</button>
        <button class="btn-secondary" onclick="generateAndShow()">Gerar Mensagem (Visualizar)</button>
      </div>

      <label for="final-message">Mensagem Gerada</label>
      <textarea id="final-message" readonly placeholder="A mensagem aparecerá aqui..."></textarea>

      <button class="btn-secondary" onclick="copyMessage()">Copiar Mensagem</button>
      <div id="copy-feedback" style="margin-top: 10px; color: green; display: none;">Copiado!</div>
    </div>

  </div>

  <script>
    let currentFlow = '';

    function showFlow(flowId) {
      // Hide all flows
      document.querySelectorAll('.flow-section').forEach(el => el.classList.remove('active'));

      // Show selected flow
      document.getElementById(flowId).classList.add('active');

      // Show output section
      document.getElementById('output-section').style.display = 'block';

      currentFlow = flowId;

      // Clear previous message
      document.getElementById('final-message').value = '';
    }

    function addOrderField() {
      const container = document.getElementById('order-list');
      const div = document.createElement('div');
      div.className = 'order-input-group';

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'order-input';
      input.placeholder = 'Número da encomenda';

      const btn = document.createElement('button');
      btn.className = 'btn-remove';
      btn.textContent = 'X';
      btn.onclick = function() {
        container.removeChild(div);
      };

      div.appendChild(input);
      div.appendChild(btn);
      container.appendChild(div);
    }

    function populateTimeSelects() {
      const startSelect = document.getElementById('time-start');
      const endSelect = document.getElementById('time-end');

      // Populate 00:00 to 23:30
      for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 30) {
          const hour = String(h).padStart(2, '0');
          const minute = String(m).padStart(2, '0');
          const time = `${hour}:${minute}`;

          const optionStart = document.createElement('option');
          optionStart.value = time;
          optionStart.text = time;
          startSelect.appendChild(optionStart);

          const optionEnd = document.createElement('option');
          optionEnd.value = time;
          optionEnd.text = time;
          endSelect.appendChild(optionEnd);
        }
      }
    }

    function updateEndTime() {
      const startSelect = document.getElementById('time-start');
      const endSelect = document.getElementById('time-end');
      const startTime = startSelect.value;

      if (startTime) {
        const [hours, minutes] = startTime.split(':').map(Number);

        // Calculate end time (+1 hour)
        let endHour = hours + 1;
        let endMinute = minutes;

        // Handle overflow (24:00 -> 00:00) if needed, but typically end time can be next day.
        // For simplicity, let's wrap around 24h
        if (endHour >= 24) {
            endHour -= 24;
        }

        const endTimeStr = `${String(endHour).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`;

        // Try to select the calculated end time if it exists in options
        // It should exist as we populated all 30min intervals
        endSelect.value = endTimeStr;
      }
    }

    // Call populate on load
    window.onload = populateTimeSelects;

    function getMessageData() {
      let subject = '';
      let body = '';
      let channel = '';
      let isValid = true;

      if (currentFlow === 'reagendamento') {
        const ordersList = Array.from(document.querySelectorAll('.order-input'))
                            .map(input => input.value.trim())
                            .filter(val => val !== '');

        if (ordersList.length === 0) {
            alert("Por favor, adicione pelo menos uma encomenda.");
            return { isValid: false };
        }

        const orders = ordersList.join(', ');
        const startTime = document.getElementById('time-start').value;
        const endTime = document.getElementById('time-end').value;

        if (!startTime || !endTime) {
            alert("Por favor, preencha a janela de horário.");
            return { isValid: false };
        }

        const timeWindow = `${startTime} às ${endTime}`;
        const contactType = document.querySelector('input[name="contact-type"]:checked').value;
        channel = document.querySelector('input[name="channel-reag"]:checked').value;

        subject = `Reagendamento de Entrega`;
        body = `Olá, tudo bem?\n\nReferente à(s) encomenda(s): ${orders},\ninformamos que o novo horário previsto é às ${timeWindow}.\n\nEste contato está sendo realizado via ${contactType}.\n\nFicamos no aguardo da sua confirmação.\n\nObrigado.`;

        if (channel === 'WhatsApp') {
            // For WhatsApp, usually just the body text is used, optionally subject as first line
            body = `*${subject}*\n${body}`;
        }

      } else if (currentFlow === 'alerta') {
        const time = document.getElementById('alert-time').value;

        if (!time) {
            alert("Por favor, preencha a hora.");
            return { isValid: false };
        }

        channel = document.querySelector('input[name="channel-alert"]:checked').value;
        subject = `Alerta Operacional`;
        body = `Preciso de motorista às ${time}.\nSolicito apoio urgente.`;

      } else if (currentFlow === 'outro') {
        const order = document.getElementById('other-order').value.trim();
        const description = document.getElementById('other-desc').value.trim();

        if (!order) {
            alert("Por favor, preencha o número da encomenda.");
            return { isValid: false };
        }
        if (!description) {
            alert("Por favor, preencha a descrição.");
            return { isValid: false };
        }

        channel = document.querySelector('input[name="channel-other"]:checked').value;
        subject = `Alerta Operacional | ${order}`;
        body = `${order}\n${description}`;
      }

      return { isValid, subject, body, channel };
    }

    function generateAndShow() {
      const data = getMessageData();
      if (!data.isValid) return;

      let fullMessage = '';
      if (data.channel === 'E-mail') {
          fullMessage = `Assunto:\n${data.subject}\n\nMensagem:\n${data.body}`;
      } else {
          fullMessage = data.body;
      }
      document.getElementById('final-message').value = fullMessage;
    }

    function generateAndSend() {
      const data = getMessageData();
      if (!data.isValid) return;

      // Update the textarea so the user can see what was sent
      generateAndShow();

      if (data.channel === 'WhatsApp') {
        // Use the hidden phone input value which is cleaned
        // Or hardcode as per request: +1 (555) 884-1462 -> 15558841462
        // If currentFlow is Reagendamento, use that phone. For others, it wasn't specified but likely same bot?
        // Actually, the prompt says "O número de telefone será sempre o mesmo que já informei anteriormente."
        // So we use 15558841462 for all WhatsApp flows.
        const phone = "15558841462";
        const url = `https://wa.me/${phone}?text=${encodeURIComponent(data.body)}`;
        window.open(url, '_blank');
      } else if (data.channel === 'E-mail') {
        const to = "help@lyzer.pt";
        const url = `mailto:${to}?subject=${encodeURIComponent(data.subject)}&body=${encodeURIComponent(data.body)}`;
        window.open(url, '_blank');
      }
    }

    function copyMessage() {
      const copyText = document.getElementById("final-message");
      copyText.select();
      copyText.setSelectionRange(0, 99999); /* For mobile devices */

      navigator.clipboard.writeText(copyText.value).then(() => {
        const feedback = document.getElementById('copy-feedback');
        feedback.style.display = 'block';
        setTimeout(() => {
            feedback.style.display = 'none';
        }, 2000);
      });
    }
  </script>
</body>
</html>
